<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Raycaster</title>
    <!-- <script
          src="https://code.jquery.com/jquery-3.3.1.min.js"
          integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
          crossorigin="anonymous"></script>-->
</head>
<body scroll="no" style="overflow: hidden">
    <canvas id="screen"></canvas>
    <canvas id="test"></canvas>
    <canvas id="minimap"></canvas>
    <script src="./globals.js"></script>
    <script src="./raycasting.js"></script>
    <script src="./draw.js"></script>
    <script>
        /* On document loaded */
        document.addEventListener("DOMContentLoaded", function(){
            MapWidth = Map[0].length;
            MapHeight = Map.length;

            screenInit();
            bindKeys();
            gameCycle();
        }, false);

        function screenInit(){
            var screen_canvas = document.getElementById("screen");
            screen_canvas.width = ScreenWidth * ScreenScale;
            screen_canvas.height = ScreenHeight * ScreenScale;
        }

        function bindKeys(){
            document.onkeydown = function(e) {
                e = e || window.event;
                e.preventDefault(); //prevent default scrolling
                switch(e.keyCode) {
                    case 38: //Up
                        player.speed = 1;
                        break;
                    case 40: //Down
                        player.speed = -1;
                        break;
                    case 37: //Left
                        player.dir = -1;
                        break;
                    case 39: //Right
                        player.dir = 1;
                        break;
                }
            }

            document.onkeyup = function(e) {
                e = e || window.event;
                switch(e.keyCode){
                    case 38:
                    case 40:
                        player.speed = 0;
                        break;
                    case 37:
                    case 39:
                        player.dir = 0;
                        break;
                }
            }
        }
        function gameCycle(){
            move();
            drawMiniMap();
            castRays();
            drawScreen();
            drawText();
            setTimeout(gameCycle, 1000/30); //30 Frames babyyy
        }

        var player = {
            x : 1,
            y : 2,
            dir : 0, //turning direction, left or right
            speed : 0, //forward -> 1, backwards -> -1
            rot : 0, // angle of rotation
            moveRate : 0.18,
            rotRate : 6 * Math.PI/180 //rate of rotation
        }

        function move(){
            var moveStep = player.speed * player.moveRate; //determines how far player should move
            player.rot += player.dir * player.rotRate; //rotation modified by direction

            // Calculate new x, y pos of player with trig
            var newX = player.x + Math.cos(player.rot) * moveStep; //Cos gets the x value of rotation, which determines how far along the x axix moveStep should being modified
            var newY = player.y + Math.sin(player.rot) * moveStep;

            // Check if new x, y is out of bounds
            if (newY < 0 || newY >= MapHeight*MiniMapScale || newX < 0 || newX >= MapWidth*MiniMapScale) {
                console.log(newX + " " + newY);
                return;
            }

            // Check if new x, y is occupying a wall
            // Use both ceil and floor to consider both ends of the walls
            if(Map[Math.floor(newY)][Math.floor(newX)] != 0){
                return;
            }

            // Set new position
            player.x = newX;
            player.y = newY;
        }
    </script>
</body>
</html>
